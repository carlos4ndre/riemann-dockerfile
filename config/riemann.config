; vim: filetype=clojure

(logging/init :file "riemann.log")

; Email settings
(def email (mailer {:host "maildev"
                    :port 25
                    :from "riemann@maildev"}))
(def mail-rescue-team (email "rescue-team@maildev"))
(def mail-supply-team (email "supply-team@maildev"))

; Listen on all interfaces for TCP (5555/5556) and UDP (5555)
(let [host "0.0.0.0"]
  (tcp-server :host host)
  (udp-server :host host)
  (ws-server  :host host))

; Expire old events from the index every 30 seconds.
(periodically-expire 30)

; Log specific events
(streams
  (where (or (tagged "creature")
             (tagged "weapon")
             (tagged "player"))
         #(info %)))

; Email notifications
(streams
  (where (and (state "critical")
              (tagged "player"))
    mail-rescue-team))

(streams
  (where (and (state "critical")
              (tagged "weapon"))
    mail-supply-team))

; Index all events
(let [index (index)]
  (streams index))
